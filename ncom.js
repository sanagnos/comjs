// ============================================================================
// comjs
// ============================================================================
// Name      : comjs
// Version   : 0.0.3
// Build date: 30-10-2014
// 
// Copyright (c) 2014, Stelios Anagnostopoulos <stelios@outlook.com>
// All rights reserved.
// ============================================================================
"use strict";function registerRequests(a){a instanceof Array||(a=[a]);for(var b,c,d=0,e=a.length;e>d;d++)if(b=a[d],"object"==typeof b)for(c in b)requests[c]=b[c];else walkSync(b,function(a){registerRequests(require(resolve(a)))})}function unregisterRequests(a){a instanceof Array||(a=[a]);for(var b=0,c=a.length;c>b;b++)requests[a[b]]&&delete requests[a[b]]}function registerFiles(a){a instanceof Array||(a=[a]);for(var b,c,d,e,f,g,h,i,j=0,k=a.length;k>j;j++)if(b=a[j],"object"==typeof b)for(c in b)for(d=b[c],"string"==typeof d&&(d=[d]),e=0,f=d.length;f>e;e++)walkSync(d[e],function(a){switch(g=a.match(/.*\.(.*)/),h=null,!g||g[g.length-1]){case"js":h="script/javascript";break;case"css":h="text/css";break;case"html":h="text/html";break;default:h="text/plain"}i=d[e]===a?join(c,basename(a)).replace(/\\/g,"/"):join(c,a).replace(/\\/g,"/"),a=resolve(a),requests[i]=function(b){return function(c,d){d.writeHead(200,{"Content-Type":b}),createReadStream(a).pipe(d)}}(h)});else walkSync(b,function(a){registerFiles(require(resolve(a)))})}function unregisterFiles(a){unregisterRequests(a)}function registerServices(a,b){var c=!1;a instanceof Array||(a=[a]);for(var d,e,f=0,g=a.length;g>f;f++)if(d=a[f],"object"==typeof d)for(e in d)services[e]=d[e],services[e].perms&&services[e].perms.length||(c=!0);else walkSync(d,function(){registerServices(require(resolve(d)),!0)});!b&&c&&generatePublicProxyStub()}function unregisterServices(a){var b=!1;a instanceof Array||(a=[a]);for(var c=0,d=a.length;d>c;c++)services[a[c]]&&(services[a[c]].perms&&services[a[c]].perms.length||(b=!0),delete services[a[c]]);b&&generatePublicProxyStub()}function generatePublicProxyStub(){pubStub={},pubProxy={};var a,b;for(a in services)if(!services[a].perms||!services[a].perms.length){pubStub[a]="function"==typeof services[a]?services[a]():services[a],pubProxy[a]={};for(b in pubStub[a])"name"!==b&&"perms"!==b&&(pubProxy[a][b]=1)}}function walkSync(a,b){if(a instanceof Array){if(!a.length)return;for(var c=a.length;c--;)walkSync(a[c],b)}else{if(!statSync(a).isDirectory())return b(a);for(var d,e,f=readdirSync(a),c=f.length;c--;)d=join(a,f[c]),e=statSync(d),e.isDirectory()?walkSync(d,b):b(d)}}function init(a,b){a.requests&&registerRequests(a.requests),a.services&&registerServices(a.services),a.files&&registerFiles(a.files.concat([{"/":join(__dirname,"./bcom.js")}])),httpServer=createHttpServer(function(a,b){requests[a.url]&&requests[a.url](a,b)}),httpServer.listen(a.port||process.env.PORT,function(){"function"==typeof b&&b()}),webSocketServer=new WebSocketServer({server:httpServer}),webSocketServer.on("connection",function(a){var b=pubStub,c=pubProxy,d={};a.on("message",function(e){var f=parseJSON(e);if(4!==f.length)return a.send(0);var g=f[0],h=f[1],i=f[2],j=f[3];if("root"===g){if("close"===h)return a.close();if("auth"===h)return auth.apply(d,i.concat(function(d){d||(d=[]);var e,f;for(var g in services)for(e=d.length;e--;)if(services[g].perms&&services[g].perms.indexOf(d[e])>=0){b[g]="function"==typeof services[g]?services[g]():services[g],c[g]={};for(f in b[g])"name"!==f&&"perms"!==f&&(c[g][f]=1)}a.send(serialize([[c],j]))}))}if(!b[g]||!b[g][h])return a.send(0);var k={send:function(){a.send(serialize([slice.call(arguments),j]))},done:function(){a.send(serialize([slice.call(arguments),j,1]))}};b[g][h].apply(d,i.concat(k))})})}function exit(a){webSocketServer.close(),httpServer.close(function(){a&&a()})}function open(a,b){var c,d,e;"string"==typeof a?(c=a,e=[],d=!1):(c=a.path,d=a.wss,e=a.auth||[]),arguments.length<3&&"function"==typeof d&&(b=d,d=!1);var c=(d?"wss://":"ws://")+c.match(/\/\/(.*)/)[1];connected&&websocket.close(),callback={},websocket=new WebSocket(c),websocket.onopen=function(){connected=!0,send("root","auth",e,function(a){proxify(a),b&&b()})},websocket.onclose=function(){connected=!1},websocket.onmessage=function(a){if(a.data.length){var b=parseJSON(a.data),c=b[0],d=b[1],e=b[2];callback[d]&&callback[d].apply({done:1===e},c),e&&delete callback[d]}}}function close(){if(connected)if(websocket.bufferredAmount)var a=setInterval(function(){clearInterval(a),websocket.close()},100);else websocket.close()}function send(a,b,c,d){connected||connect();var e=Date.now(),f=serialize([a,b,c,e]);callback[e]=d,websocket.send(f)}function proxify(a){proxy={};var b,c;for(b in a){proxy[b]||(proxy[b]={});for(c in a[b])proxy[b][c]=function(a,b){return function(){var c=slice.call(arguments),d="function"==typeof c[c.length-1]?c.pop():null;send(a,b,c,d)}}(b,c)}}function request(a,b,c,d,e){"string"==typeof b&&(e=d,d=c,c=b),"function"==typeof d&&(e=d,d=null);var f=parseUrl(a),g="https:"===f.protocol?submitHttps:submitHttp,h=g({hostname:f.hostname,url:f.url,method:c,headers:d},function(a){var b="";a.setEncoding("utf8"),a.on("data",function(a){b+=a}),a.on("end",function(){e(b)})});b&&h.write("string"==typeof b?b:parseJSON(b)),h.on("error",function(a){throw new Error(a)}),h.end()}function submitGet(a,b,c){request(a,"GET",b,c)}function submitPut(a,b,c,d){request(a,b,"PUT",c,d)}function submitPost(a,b,c,d){request(a,b,"POST",c,d)}function submitDelete(a,b,c){request(a,"GET",b,c)}function define(a,b){b instanceof Array||(b=[b]);for(var c=new Array(b.length),d=0,e=b.length;e>d;d++)bind(a.prototype,b[d]),c[d]=keysOf(b[d]);var f=function(){if(a.prototype._preInit)for(var b=0,d=a.prototype._preInit.length;d>b;b++)a.prototype._preInit[b].apply(this,arguments);if(a.apply(this,arguments),a.prototype._postInit)for(var b=0,d=a.prototype._postInit.length;d>b;b++)a.prototype._postInit[b].apply(this,arguments);for(var e,f,g=c.length;g--;)for(e=c[g],f=e.length;f--;)if("string"==typeof this[e[f]]&&0===this[e[f]].indexOf("@require"))throw new Error("missing contract member: "+e[f])};return f.prototype=new a,f.prototype.constructor=f,f}function bind(a,b){var c,d={},e=[];for(var f in b)"string"==typeof b[f]&&"@require"!==b[f]?d[f]=function(a){return{configurable:!0,get:function(){for(var b=this[a[0]],c=1,d=a.length;d>c;c++)b=b[a[c]];return b},set:function(b){for(var c=this[a[0]],d=1,e=a.length-1;e>d;d++)c=c[a[d]];c[a[a.length-1]]=b}}}(b[f].split(".")):"object"==typeof b[f]?d[f]=b[f]:"function"==typeof b[f]&&("preInit"===f||"postInit"===f?(c="_"+f,a[c]||(a[c]=[]),a[c][a[c].length]=b[f]):e[e.length]=[f,b[f]]);defineProperties(a,d);for(var f,g,h,i=0,j=e.length;j>i;i++)f=e[i][0],g=e[i][1],a[f]&&(h=a[f]),a[f]=g,a[f].super=h}var WebSocket=require("ws"),WebSocketServer=WebSocket.Server,http=require("http"),https=require("https"),fs=require("fs"),path=require("path"),url=require("url"),createHttpServer=http.createServer,submitHttp=http.request,submitHttps=https.request,serialize=JSON.stringify,parseJSON=JSON.parse,slice=Array.prototype.slice,join=path.join,basename=path.basename,resolve=path.resolve,parseUrl=url.parse,readdirSync=fs.readdirSync,statSync=fs.statSync,createReadStream=fs.createReadStream,keysOf=Object.keys,defineProperties=Object.defineProperties,httpServer=null,webSocketServer=null,requests={},services={},pubStub={},pubProxy={},auth=function(){arguments[arguments.length-1]([])},websocket,proxy,callback,connected=!1;module.exports={init:init,exit:exit,registerRequests:registerRequests,registerFiles:registerFiles,registerServices:registerServices,get proxy(){return proxy},open:open,close:close,submitGet:submitGet,submitPut:submitPut,submitPost:submitPost,submitDelete:submitDelete,define:define};