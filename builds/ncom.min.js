"use strict";function define(a,b){b instanceof Array||(b=[b]);for(var c=new Array(b.length),d=0,e=b.length;e>d;d++)bind(a.prototype,b[d]),c[d]=keysOf(b[d]);var f=function(){if(a.prototype._preInit)for(var b=0,d=a.prototype._preInit.length;d>b;b++)a.prototype._preInit[b].apply(this,arguments);if(a.apply(this,arguments),a.prototype._postInit)for(var b=0,d=a.prototype._postInit.length;d>b;b++)a.prototype._postInit[b].apply(this,arguments);for(var e,f,g=c.length;g--;)for(e=c[g],f=e.length;f--;)if("string"==typeof this[e[f]]&&0===this[e[f]].indexOf("@require"))throw new Error("missing contract member: "+e[f])};return f.prototype=new a,f.prototype.constructor=f,f}function bind(a,b){var c,d={},e=[];for(var f in b)"string"==typeof b[f]&&"@require"!==b[f]?d[f]=function(a){return{configurable:!0,get:function(){for(var b=this[a[0]],c=1,d=a.length;d>c;c++)b=b[a[c]];return b},set:function(b){for(var c=this[a[0]],d=1,e=a.length-1;e>d;d++)c=c[a[d]];c[a[a.length-1]]=b}}}(b[f].split(".")):"object"==typeof b[f]?d[f]=b[f]:"function"==typeof b[f]&&("preInit"===f||"postInit"===f?(c="_"+f,a[c]||(a[c]=[]),a[c][a[c].length]=b[f]):e[e.length]=[f,b[f]]);defineProperties(a,d);for(var f,g,h,i=0,j=e.length;j>i;i++)f=e[i][0],g=e[i][1],a[f]&&(h=a[f]),a[f]=g,a[f].super=h}function walkSync(a,b){if(a instanceof Array){if(!a.length)return;for(var c=a.length;c--;)walkSync(a[c],b)}else{if(!statSync(a).isDirectory())return b(a);for(var d,e,f=readdirSync(a),c=f.length;c--;)d=join(a,f[c]),e=statSync(d),e.isDirectory()?walkSync(d,b):b(d)}}var com={},keysOf=Object.keys,defineProperties=Object.defineProperties;com.def=define,com.rpc=function a(){function b(a,b){var c,f,g;"string"==typeof a?(c=a,g=[],f=!1):(c=a.path,f=a.wss,g=a.auth||[]),arguments.length<3&&"function"==typeof f&&(b=f,f=!1);var c=(f?"wss://":"ws://")+c.match(/\/\/(.*)/)[1];v&&i.close(),k={},i=new l(c),i.onopen=function(){v=!0,d("root","auth",g,function(a){e(a),b&&b()})},i.onclose=function(){v=!1},i.onmessage=function(a){if(a.data.length){var b=u(a.data),c=b[0],d=b[1],e=b[2];k[d]&&k[d].apply({done:1===e},c),e&&delete k[d]}}}function c(){if(v)if(i.bufferredAmount)var a=setInterval(function(){clearInterval(a),i.close()},100);else i.close()}function d(a,b,c,d){v||connect();var e=Date.now(),f=t([a,b,c,e]);k[e]=d,i.send(f)}function e(a){j={};var b,c;for(b in a){j[b]||(j[b]={});for(c in a[b])j[b][c]=function(a,b){return function(){var c=s.call(arguments),e="function"==typeof c[c.length-1]?c.pop():null;d(a,b,c,e)}}(b,c)}}function f(a,b,c,d){var e=a.match(/^https/)?q:p,f=r(a),g=e({hostname:f.hostname,path:f.path,method:c||"GET"},function(a){var b="";a.setEncoding("utf8"),a.on("data",function(a){b+=a}),a.on("end",function(){d(b)})});b&&g.write("string"==typeof b?b:u(b)),g.on("error",function(a){throw new Error(a)}),g.end()}function g(a,b,c){arguments.length<3?(c=b,b=""):("string"!=typeof b&&(b=t(b)),b=encodeURIComponent(b),a+=b),f(a+b,null,"GET",c)}function h(a,b,c){f(a,b,"POST",c)}var i,j,k,l=require("ws"),m=require("http"),n=require("https"),o=require("url"),p=m.request,q=n.request,r=o.parse,s=Array.prototype.slice,t=JSON.stringify,u=JSON.parse,v=(Object.defineProperty,Math.floor,!1);return{open:b,close:c,get proxy(){return j},get:g,post:h,create:function(){new a}}}();var WebSocketServer=require("ws").Server,http=require("http"),fs=require("fs"),path=require("path"),createHttpServer=http.createServer,serialize=JSON.stringify,parse=JSON.parse,slice=Array.prototype.slice,join=path.join,basename=path.basename,resolve=path.resolve,readdirSync=fs.readdirSync,statSync=fs.statSync,lstatSync=fs.lstatSync,createReadStream=fs.createReadStream;com.srv=function b(a,c){function d(a){a instanceof Array||(a=[a]);for(var b,c,e=0,f=a.length;f>e;e++)if(b=a[e],"object"==typeof b)for(c in b)l[c]=b[c];else walkSync(b,function(a){d(require(resolve(a)))})}function e(a){a instanceof Array||(a=[a]);for(var b,c,d,f,g,h,i,j,k=0,m=a.length;m>k;k++)if(b=a[k],"object"==typeof b)for(c in b)for(d=b[c],"string"==typeof d&&(d=[d]),f=0,g=d.length;g>f;f++)walkSync(d[f],function(a){switch(h=a.match(/.*\.(.*)/),i=null,!h||h[h.length-1]){case"js":i="script/javascript";break;case"css":i="text/css";break;case"html":i="text/html";break;default:i="text/plain"}j=d[f]===a?join(c,basename(a)).replace(/\\/g,"/"):join(c,a).replace(/\\/g,"/"),a=resolve(a),l[j]=function(b){return function(c,d){d.writeHead(200,{"Content-Type":b}),createReadStream(a).pipe(d)}}(i)});else walkSync(b,function(a){e(require(resolve(a)))})}function f(a,b){var c=!1;a instanceof Array||(a=[a]);for(var d,e,h=0,i=a.length;i>h;h++)if(d=a[h],"object"==typeof d)for(e in d)m[e]=d[e],m[e].perms&&m[e].perms.length||(c=!0);else walkSync(d,function(){f(require(resolve(d)),!0)});!b&&c&&g()}function g(){n={},o={};var a,b;for(a in m)if(!m[a].perms||!m[a].perms.length){n[a]="function"==typeof m[a]?m[a]():m[a],o[a]={};for(b in n[a])"name"!==b&&"perms"!==b&&(o[a][b]=1)}}function h(a,b){a.requests&&d(a.requests),a.files&&e(a.files),a.services&&f(a.services),j=createHttpServer(function(a,b){l[a.url]&&l[a.url](a,b)}),j.listen(a.port||process.env.PORT,function(){"function"==typeof b&&b()}),k=new WebSocketServer({server:j}),k.on("connection",function(a){var b=n,c=o,d={};a.on("message",function(e){var f=parse(e);if(4!==f.length)return a.send(0);var g=f[0],h=f[1],i=f[2],j=f[3];if("root"===g){if("close"===h)return a.close();if("auth"===h)return p.apply(d,i.concat(function(d){d||(d=[]);var e,f;for(var g in m)for(e=d.length;e--;)if(m[g].perms&&m[g].perms.indexOf(d[e])>=0){b[g]="function"==typeof m[g]?m[g]():m[g],c[g]={};for(f in b[g])"name"!==f&&"perms"!==f&&(c[g][f]=1)}a.send(serialize([[c],j]))}))}if(!b[g]||!b[g][h])return a.send(0);var k={send:function(){a.send(serialize([slice.call(arguments),j]))},done:function(){a.send(serialize([slice.call(arguments),j,1]))}};b[g][h].apply(d,i.concat(k))})})}function i(a){k.close(),j.close(function(){a&&a()})}c=arguments[arguments.length-1],"object"!=typeof a&&(a={});var j=null,k=null,l={},m={},n={},o={},p=function(){arguments[arguments.length-1]([])};return{open:h,close:i,registerRequests:d,registerFiles:e,registerServices:f,create:function(){return new b}}}(),"undefined"==typeof window?module.exports=com:window.com=com;